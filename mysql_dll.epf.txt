Перем СоединениеБД;
Перем последняя_ошибка;

Процедура запомнитьОшибку(ошибка)
	последняя_ошибка = ошибка;
КонецПроцедуры

// Соединение с базой данных
// парам: dsn - реквизиты подключения в формате "driver={mysql odbc 5.1 driver}server=<HOST>;uid=<LOGIN>; pwd=<PASSWORD>; database=<DB>;port=<PORT>"
Функция connect(dsn) Экспорт 
	Попытка	
		СоединениеБД = Новый COMОбъект("ADODB.Connection");
		СоединениеБД.Open(dsn);	
		запомнитьОшибку(null);
	Исключение
		запомнитьОшибку(ОписаниеОшибки());
		СоединениеБД = null;
	КонецПопытки;
	
	Возврат СоединениеБД;
КонецФункции
// Закрытие соединения с базой данных
// парам: _sql - ссылка на COMОбъект("ADODB.Connection") 
Функция close(_sql = "") Экспорт 
	Если (_sql = "") Тогда
		_sql = СоединениеБД;
	КонецЕсли;	
	_sql.close();
КонецФункции

// Выполнение sql-запроса к БД
// парам: _sql - ссылка на COMОбъект("ADODB.Connection") 
//		  sql - sql-запрос
// возврат: эземпляр объъекта COMОбъект("ADODB.Recordset")
Функция query(sql, _sql = "") Экспорт
	Попытка
		Если (_sql = "") Тогда
			_sql = СоединениеБД;
		КонецЕсли;	
		result = Новый COMОбъект("ADODB.Recordset"); 
		result.ActiveConnection = _sql;
		result.Open(sql);
		result.MoveFirst();
		запомнитьОшибку(null);
	Исключение
		запомнитьОшибку(ОписаниеОшибки());
	КонецПопытки;
	
	Возврат result;
КонецФункции

// Преобразует результат sql-запроса в массив
// парам: result = эземпляр объъекта COMОбъект("ADODB.Recordset")
// возврат: массив, элементы которого объекты типа "Структура"
Функция getAssoc(result) Экспорт
	Попытка
		таб = Новый Массив();
	 	result.MoveFirst(); 	
		Пока result.EOF()=0 Цикл
			ОбработкаПрерыванияПользователя();
			стр = Новый Структура();
			Для ф = 0 По result.Fields.Count-1 Цикл
				стр.Вставить(result.Fields(Ф).Name, result.Fields(Ф).Value);
			КонецЦикла;	
			таб.Добавить(стр);
			result.MoveNext();
		КонецЦикла;
		result.MoveFirst();
		запомнитьОшибку(null);
	Исключение
		запомнитьОшибку(ОписаниеОшибки());
		таб = null;
	КонецПопытки;
	Возврат таб;
КонецФункции

// Выполенение sql-запроса и возврат единственного значения
// парам: _sql - ссылка на COMОбъект("ADODB.Connection") 
//		  sql - sql-запрос
// возврат: первое значение из результата запроса
Функция getOne(sql, _sql = "") Экспорт
	Попытка
		result = query(sql, _sql);
	 	result.MoveFirst(); 
		результат = result.Fields(0).Value;
		запомнитьОшибку(null);
	Исключение
		запомнитьОшибку(ОписаниеОшибки());
		результат = null;
	КонецПопытки;
	
	Возврат результат;
КонецФункции


// возвращает текст последней ошибки
Функция error() Экспорт
	возврат последняя_ошибка;
КонецФункции	
